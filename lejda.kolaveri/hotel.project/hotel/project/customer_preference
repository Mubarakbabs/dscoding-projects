import pandas as pd

from utils import calculate_satisfaction_percentage


def allocate_preferred_hotel(guest_id, guest_row, hotels, preferences):
    guest_preferred_hotels = preferences[preferences['guest'] == guest_id]['hotel']

    for _, preferred_hotel_id in guest_preferred_hotels.items():
        preferred_hotel_row = hotels.loc[preferred_hotel_id]

        if preferred_hotel_row['rooms'] > 0:
            preferred_hotel_row['rooms'] -= 1

            paid_price_coefficient = 1 - guest_row['discount']
            paid_price = preferred_hotel_row['price'] * paid_price_coefficient

            satisfaction = calculate_satisfaction_percentage(guest_id, preferred_hotel_id, preferences)

            return [guest_id, preferred_hotel_id, satisfaction, paid_price]

    return None


def get_customer_preference_allocation(hotels, guests, preferences):
    allocation = pd.DataFrame(columns=['guest_id', 'hotel_id', 'satisfaction_percentage', 'paid_price'])

    for guest_id, guest_row in guests.iterrows():
        allocation_entry = allocate_preferred_hotel(guest_id, guest_row, hotels, preferences)
        if allocation_entry is not None:
            allocation.loc[len(allocation)] = allocation_entry

    return allocation
